# â° åœ¨çº¿æ—¶é•¿è®°å½•åŠŸèƒ½å®ç°æŠ¥å‘Š

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æˆåŠŸå®ç°äº†å®Œæ•´çš„åœ¨çº¿æ—¶é•¿è®°å½•ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ—¶é•¿è¿½è¸ªã€ç»Ÿè®¡åˆ†æã€é‡Œç¨‹ç¢‘å¥–åŠ±å’ŒUIå±•ç¤ºç­‰åŠŸèƒ½ã€‚

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. ğŸ“Š æ—¶é•¿è¿½è¸ªç³»ç»Ÿ

#### OnlineTimeTracker æ ¸å¿ƒç±»
```javascript
class OnlineTimeTracker {
    // æ—¶é•¿æ•°æ®
    totalOnlineTime: 0,        // æ€»åœ¨çº¿æ—¶é•¿ï¼ˆç§’ï¼‰
    dailyOnlineTime: 0,        // ä»Šæ—¥åœ¨çº¿æ—¶é•¿ï¼ˆç§’ï¼‰
    currentSessionTime: 0,     // å½“å‰ä¼šè¯æ—¶é•¿ï¼ˆç§’ï¼‰
    
    // çŠ¶æ€ç®¡ç†
    isActive: true,            // æ˜¯å¦æ´»è·ƒçŠ¶æ€
    lastActiveTime: Date.now(), // æœ€åæ´»åŠ¨æ—¶é—´
    afkThreshold: 5 * 60 * 1000, // AFKé˜ˆå€¼ï¼ˆ5åˆ†é’Ÿï¼‰
    
    // æ•°æ®è®°å½•
    timeRecords: {
        daily: {},   // æ¯æ—¥è®°å½• { '2024-01-01': 3600 }
        weekly: {},  // æ¯å‘¨è®°å½•
        monthly: {} // æ¯æœˆè®°å½•
    }
}
```

#### æ™ºèƒ½æ´»åŠ¨æ£€æµ‹
- **ç”¨æˆ·æ´»åŠ¨ç›‘å¬**ï¼šé¼ æ ‡ç§»åŠ¨ã€ç‚¹å‡»ã€é”®ç›˜è¾“å…¥ã€æ»šåŠ¨ã€è§¦æ‘¸
- **é¡µé¢çŠ¶æ€ç›‘å¬**ï¼šé¡µé¢å¯è§æ€§å˜åŒ–ã€çª—å£ç„¦ç‚¹å˜åŒ–
- **AFKæ£€æµ‹**ï¼š5åˆ†é’Ÿæ— æ´»åŠ¨è‡ªåŠ¨æš‚åœè®¡æ—¶
- **è‡ªåŠ¨æ¢å¤**ï¼šæ£€æµ‹åˆ°æ´»åŠ¨åè‡ªåŠ¨æ¢å¤è®¡æ—¶

### 2. ğŸ† é‡Œç¨‹ç¢‘å¥–åŠ±ç³»ç»Ÿ

#### å¥–åŠ±ç­‰çº§è®¾è®¡
| æ—¶é•¿ | ç­‰çº§ | å¥–åŠ± | æè¿° |
|------|------|------|------|
| 30åˆ†é’Ÿ | åˆå­¦è€… | 50ç»éªŒ + 10é‡‘å¸ | åœ¨çº¿30åˆ†é’Ÿ |
| 1å°æ—¶ | ä¸“æ³¨è€… | 100ç»éªŒ + 25é‡‘å¸ | åœ¨çº¿1å°æ—¶ |
| 2å°æ—¶ | å‹¤å¥‹è€… | 200ç»éªŒ + 50é‡‘å¸ | åœ¨çº¿2å°æ—¶ |
| 4å°æ—¶ | å­¦éœ¸ | 400ç»éªŒ + 100é‡‘å¸ | åœ¨çº¿4å°æ—¶ |
| 8å°æ—¶ | ä¿®ç‚¼ç‹‚äºº | 800ç»éªŒ + 200é‡‘å¸ | åœ¨çº¿8å°æ—¶ |

#### å¥–åŠ±å‘æ”¾æœºåˆ¶
```javascript
grantMilestoneReward(milestone) {
    // å‘æ”¾æ¸¸æˆå†…å¥–åŠ±
    if (window.gameData?.player) {
        player.gainExp(milestone.reward.exp);
        player.coins += milestone.reward.coins;
    }
    
    // æ˜¾ç¤ºé€šçŸ¥
    this.showMilestoneNotification(milestone);
    
    // æµè§ˆå™¨é€šçŸ¥ï¼ˆå¦‚æœç”¨æˆ·å…è®¸ï¼‰
    if (Notification.permission === 'granted') {
        new Notification(`æ•°é“ä»™é€” - ${milestone.name}`, {
            body: milestone.desc,
            icon: '/favicon.ico'
        });
    }
}
```

### 3. ğŸ¨ UIæ˜¾ç¤ºç³»ç»Ÿ

#### OnlineTimeUI ç»„ä»¶
- **å®æ—¶æ—¶é•¿æ˜¾ç¤º**ï¼šå³ä¸Šè§’æ˜¾ç¤ºå½“å‰ä¼šè¯æ—¶é•¿
- **çŠ¶æ€æŒ‡ç¤ºå™¨**ï¼šç»¿è‰²ï¼ˆæ´»è·ƒï¼‰/ æ©™è‰²ï¼ˆAFKï¼‰
- **ç»Ÿè®¡é¢æ¿**ï¼šç‚¹å‡»å±•å¼€è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
- **é‡Œç¨‹ç¢‘è¿›åº¦**ï¼šå¯è§†åŒ–è¿›åº¦æ¡æ˜¾ç¤º

#### UIå¸ƒå±€è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¸¸æˆç•Œé¢                    â° åœ¨çº¿æ—¶é•¿  â”‚
â”‚                           00:15:32     â”‚
â”‚                              ğŸŸ¢       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç»Ÿè®¡é¢æ¿å†…å®¹
- æ€»åœ¨çº¿æ—¶é•¿ã€ä»Šæ—¥åœ¨çº¿ã€æœ¬æ¬¡ä¼šè¯
- å¹³å‡æ¯æ—¥æ—¶é•¿ã€æ¸¸æˆå¤©æ•°
- é‡Œç¨‹ç¢‘è¿›åº¦æ¡å’Œå®ŒæˆçŠ¶æ€
- å®æ—¶æ•°æ®æ›´æ–°

### 4. ğŸ’¾ æ•°æ®æŒä¹…åŒ–

#### æœ¬åœ°å­˜å‚¨
```javascript
// ä¿å­˜æ ¼å¼
{
    totalOnlineTime: 7200,
    timeRecords: {
        daily: { '2024-01-11': 3600 },
        weekly: { '2024-W02': 7200 },
        monthly: { '2024-01': 7200 }
    },
    achievedMilestones: ['milestone_0', 'milestone_1'],
    lastSaveTime: 1704988800000
}
```

#### äº‘ç«¯åŒæ­¥ï¼ˆå¯é€‰ï¼‰
```javascript
async saveToCloud(data) {
    const response = await fetch('/api/save-online-time', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            playerId: window.gameData.username,
            timeData: data
        })
    });
}
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. äº‹ä»¶ç›‘å¬ç³»ç»Ÿ
```javascript
setupEventListeners() {
    // ç”¨æˆ·æ´»åŠ¨ç›‘å¬
    const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
    activityEvents.forEach(event => {
        document.addEventListener(event, () => this.updateActivity(), { passive: true });
    });
    
    // é¡µé¢çŠ¶æ€ç›‘å¬
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            this.handlePageHidden();
        } else {
            this.handlePageVisible();
        }
    });
    
    // é¡µé¢å¸è½½ç›‘å¬
    window.addEventListener('beforeunload', () => {
        this.endSession();
    });
}
```

### 2. å®šæ—¶å™¨ç®¡ç†
```javascript
startTimers() {
    // æ¯ç§’æ›´æ–°æ—¶é•¿
    this.updateTimer = setInterval(() => {
        this.updateTime();
    }, 1000);
    
    // æ¯5åˆ†é’Ÿä¿å­˜æ•°æ®
    this.saveTimer = setInterval(() => {
        this.saveTimeData();
    }, 5 * 60 * 1000);
}
```

### 3. AFKæ£€æµ‹é€»è¾‘
```javascript
updateTime() {
    if (!this.isActive || !this.sessionStartTime) return;
    
    // æ£€æŸ¥AFKçŠ¶æ€
    const timeSinceLastActivity = Date.now() - this.lastActiveTime;
    if (timeSinceLastActivity > this.afkThreshold) {
        this.pauseTracking(); // æš‚åœè®¡æ—¶
        return;
    }
    
    // æ›´æ–°æ—¶é•¿å’Œæ£€æŸ¥é‡Œç¨‹ç¢‘
    this.currentSessionTime = Math.floor((Date.now() - this.sessionStartTime) / 1000);
    this.checkMilestones();
}
```

### 4. æ•°æ®ç»Ÿè®¡ç®—æ³•
```javascript
// å¹³å‡æ¯æ—¥æ—¶é•¿
getAverageDailyTime() {
    const dailyTimes = Object.values(this.timeRecords.daily);
    if (dailyTimes.length === 0) return 0;
    
    const total = dailyTimes.reduce((sum, time) => sum + time, 0);
    return Math.floor(total / dailyTimes.length);
}

// æ—¶é—´æ ¼å¼åŒ–
formatTime(seconds) {
    if (seconds < 60) return `${seconds}ç§’`;
    if (seconds < 3600) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}åˆ†${remainingSeconds}ç§’`;
    }
    // ... æ›´å¤šæ ¼å¼åŒ–é€»è¾‘
}
```

## ğŸ® æ¸¸æˆé›†æˆ

### 1. GameScene é›†æˆ
```javascript
// åœ¨GameSceneä¸­åˆå§‹åŒ–
if (!window.gameData.onlineTimeTracker) {
    window.gameData.onlineTimeTracker = new OnlineTimeTracker();
}

// åˆ›å»ºUIç»„ä»¶
this.onlineTimeUI = new OnlineTimeUI(this, window.gameData.onlineTimeTracker);
```

### 2. å…¨å±€ç”Ÿå‘½å‘¨æœŸç®¡ç†
```javascript
// main.js ä¸­çš„æ¸…ç†é€»è¾‘
window.addEventListener('beforeunload', function() {
    if (window.gameData?.onlineTimeTracker) {
        window.gameData.onlineTimeTracker.destroy();
    }
});
```

### 3. åœºæ™¯åˆ‡æ¢å¤„ç†
```javascript
// GameScene shutdown æ–¹æ³•
shutdown() {
    if (this.onlineTimeUI) {
        this.onlineTimeUI.destroy();
        this.onlineTimeUI = null;
    }
    // æ³¨æ„ï¼šä¸é”€æ¯å…¨å±€çš„ onlineTimeTracker
}
```

## ğŸ“± å…¼å®¹æ€§è®¾è®¡

### 1. ç§»åŠ¨è®¾å¤‡ä¼˜åŒ–
- è§¦æ‘¸äº‹ä»¶ç›‘å¬
- é¡µé¢å¯è§æ€§APIæ”¯æŒ
- ç§»åŠ¨æµè§ˆå™¨åå°å¤„ç†

### 2. æµè§ˆå™¨å…¼å®¹æ€§
- ç°ä»£æµè§ˆå™¨APIæ£€æµ‹
- é™çº§å¤„ç†æ–¹æ¡ˆ
- æœ¬åœ°å­˜å‚¨å®¹é”™

### 3. æ€§èƒ½ä¼˜åŒ–
- äº‹ä»¶ç›‘å¬å™¨ä½¿ç”¨ `{ passive: true }`
- å®šæ—¶å™¨åˆç†é—´éš”è®¾ç½®
- å†…å­˜æ³„æ¼é˜²æŠ¤

## ğŸ§ª æµ‹è¯•åŠŸèƒ½

### æµ‹è¯•é¡µé¢ç‰¹æ€§
- **test-online-time.html**ï¼šå®Œæ•´åŠŸèƒ½æµ‹è¯•é¡µé¢
- **å®æ—¶ç»Ÿè®¡æ˜¾ç¤º**ï¼šåŠ¨æ€æ›´æ–°çš„ç»Ÿè®¡é¢æ¿
- **æ¨¡æ‹ŸåŠŸèƒ½**ï¼šæ´»åŠ¨æ¨¡æ‹Ÿã€AFKæ¨¡æ‹Ÿã€é‡Œç¨‹ç¢‘è§¦å‘
- **æ•°æ®ç®¡ç†**ï¼šé‡ç½®æ•°æ®ã€æ˜¾ç¤ºç»Ÿè®¡

### æµ‹è¯•åœºæ™¯
1. **æ­£å¸¸ä½¿ç”¨**ï¼šå¯åŠ¨æ¸¸æˆï¼Œè§‚å¯Ÿæ—¶é•¿ç´¯ç§¯
2. **AFKæµ‹è¯•**ï¼šæ¨¡æ‹Ÿæ— æ´»åŠ¨çŠ¶æ€ï¼ŒéªŒè¯æš‚åœæœºåˆ¶
3. **é‡Œç¨‹ç¢‘æµ‹è¯•**ï¼šæ‰‹åŠ¨è§¦å‘é‡Œç¨‹ç¢‘ï¼ŒéªŒè¯å¥–åŠ±å‘æ”¾
4. **æ•°æ®æŒä¹…åŒ–**ï¼šåˆ·æ–°é¡µé¢ï¼ŒéªŒè¯æ•°æ®ä¿å­˜
5. **è·¨ä¼šè¯æµ‹è¯•**ï¼šå¤šæ¬¡å¯åŠ¨æ¸¸æˆï¼ŒéªŒè¯ç´¯ç§¯æ•ˆæœ

## ğŸ“Š æ•°æ®åˆ†æåŠŸèƒ½

### 1. ç»Ÿè®¡ç»´åº¦
- **æ—¶é—´ç»´åº¦**ï¼šç§’ã€åˆ†é’Ÿã€å°æ—¶ã€å¤©ã€å‘¨ã€æœˆ
- **è¡Œä¸ºç»´åº¦**ï¼šæ´»è·ƒæ—¶é•¿ã€AFKæ—¶é•¿ã€ä¼šè¯æ¬¡æ•°
- **æˆå°±ç»´åº¦**ï¼šé‡Œç¨‹ç¢‘å®Œæˆæƒ…å†µã€å¥–åŠ±è·å¾—

### 2. å¯è§†åŒ–å±•ç¤º
- è¿›åº¦æ¡æ˜¾ç¤ºé‡Œç¨‹ç¢‘è¿›åº¦
- å®æ—¶æ›´æ–°çš„æ•°å­—ç»Ÿè®¡
- çŠ¶æ€æŒ‡ç¤ºå™¨æ˜¾ç¤ºå½“å‰çŠ¶æ€
- å†å²æ•°æ®å›¾è¡¨ï¼ˆå¯æ‰©å±•ï¼‰

## ğŸ”® æ‰©å±•æ–¹å‘

### 1. é«˜çº§ç»Ÿè®¡
- æ¯å°æ—¶æ´»è·ƒåº¦åˆ†æ
- å­¦ä¹ æ•ˆç‡ç»Ÿè®¡
- ç­”é¢˜æ­£ç¡®ç‡ä¸æ—¶é•¿å…³è”

### 2. ç¤¾äº¤åŠŸèƒ½
- å¥½å‹æ—¶é•¿æ’è¡Œæ¦œ
- å­¦ä¹ å°ç»„ç»Ÿè®¡
- æ—¶é•¿æŒ‘æˆ˜æ´»åŠ¨

### 3. ä¸ªæ€§åŒ–åŠŸèƒ½
- è‡ªå®šä¹‰é‡Œç¨‹ç¢‘ç›®æ ‡
- å­¦ä¹ æé†’è®¾ç½®
- æ—¶é•¿ç›®æ ‡åˆ¶å®š

### 4. æ•°æ®å¯¼å‡º
- CSVæ ¼å¼å¯¼å‡º
- å­¦ä¹ æŠ¥å‘Šç”Ÿæˆ
- æ•°æ®å¯è§†åŒ–å›¾è¡¨

## ğŸ‰ å®ç°æˆæœ

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… å®æ—¶æ—¶é•¿è¿½è¸ª
- âœ… æ™ºèƒ½AFKæ£€æµ‹
- âœ… é‡Œç¨‹ç¢‘å¥–åŠ±ç³»ç»Ÿ
- âœ… æ•°æ®æŒä¹…åŒ–
- âœ… UIç•Œé¢å±•ç¤º
- âœ… è·¨ä¼šè¯æ•°æ®ä¿æŒ

### ç”¨æˆ·ä½“éªŒ
- ğŸ¯ **æ— æ„ŸçŸ¥è¿½è¸ª**ï¼šåå°è‡ªåŠ¨è¿è¡Œï¼Œä¸å½±å“æ¸¸æˆä½“éªŒ
- ğŸ† **æ¿€åŠ±æœºåˆ¶**ï¼šé‡Œç¨‹ç¢‘å¥–åŠ±å¢åŠ æ¸¸æˆç²˜æ€§
- ğŸ“Š **æ•°æ®é€æ˜**ï¼šæ¸…æ™°çš„ç»Ÿè®¡ä¿¡æ¯å±•ç¤º
- ğŸ”„ **æ™ºèƒ½æš‚åœ**ï¼šAFKæ£€æµ‹é¿å…è™šå‡æ—¶é•¿

### æŠ€æœ¯è´¨é‡
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†çš„å®šæ—¶å™¨é—´éš”å’Œäº‹ä»¶å¤„ç†
- ğŸ›¡ï¸ **å®¹é”™å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œé™çº§æ–¹æ¡ˆ
- ğŸ’¾ **æ•°æ®å®‰å…¨**ï¼šæœ¬åœ°+äº‘ç«¯åŒé‡ä¿å­˜æœºåˆ¶
- ğŸ”§ **æ˜“äºç»´æŠ¤**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ¸…æ™°çš„ä»£ç ç»“æ„

è¿™ä¸ªåœ¨çº¿æ—¶é•¿è®°å½•åŠŸèƒ½ä¸ºæ¸¸æˆå¢åŠ äº†é‡è¦çš„ç”¨æˆ·ç²˜æ€§å’Œæ¿€åŠ±æœºåˆ¶ï¼Œå¸®åŠ©ç©å®¶æ›´å¥½åœ°äº†è§£è‡ªå·±çš„å­¦ä¹ æ—¶é—´ï¼Œå¹¶é€šè¿‡é‡Œç¨‹ç¢‘å¥–åŠ±ç³»ç»Ÿé¼“åŠ±æŒç»­å­¦ä¹ ï¼
</content>
</invoke>