# 用户名系统说明

## 🎯 功能概述

为了解决云端保存功能失败的问题，新增了用户名选择系统。每个用户可以使用自己的用户名，数据将独立保存在云端。

## ✨ 新增功能

### 1. 登录/用户名选择场景 (LoginScene)

**文件**: `src/scenes/LoginScene.js`

**功能**:
- 用户输入或选择用户名（3-20个字符）
- 支持字母、数字、中文和常见符号
- 用户名保存到 localStorage，下次自动填充
- 支持新游戏和继续游戏两种模式

**使用方式**:
- 在主菜单点击"初踏仙途"或"再續前緣"会跳转到登录场景
- 输入用户名后按 Enter 或点击按钮确认
- 用户名会自动保存，下次进入时自动填充

### 2. 修改保存/加载逻辑

**修改的文件**:
- `src/scenes/GameScene.js` - 使用用户名作为 playerId
- `functions/api/save.js` - 使用传入的 playerId（用户名）
- `functions/api/load.js` - 使用传入的 playerId（用户名）

**改进**:
- 每个用户的数据独立存储（使用用户名作为 key）
- 解决了多个用户共享 `default_player` 导致的数据冲突问题
- 云端保存现在可以正常工作

### 3. 主菜单集成

**修改的文件**:
- `src/core/MenuSystem.js` - 菜单按钮跳转到 LoginScene
- `src/main.js` - 添加 LoginScene 到场景列表

**流程**:
1. 主菜单 → "初踏仙途" → LoginScene（新游戏）
2. 主菜单 → "再續前緣" → LoginScene（继续游戏）

## 📋 使用流程

### 新游戏流程
1. 启动游戏 → BootScene → MainMenuScene
2. 点击"初踏仙途"
3. 进入 LoginScene，输入用户名
4. 点击"新游戏"或按 Enter
5. 开始新游戏，数据保存到云端（使用用户名作为 playerId）

### 继续游戏流程
1. 启动游戏 → BootScene → MainMenuScene
2. 点击"再續前緣"
3. 进入 LoginScene（自动填充上次的用户名）
4. 点击"继续游戏"或按 Enter
5. 从云端加载存档数据

## 🔧 技术实现

### 用户名存储
- **localStorage key**: `game_username`
- **全局变量**: `window.gameData.username` 和 `window.gameData.playerId`

### 云端保存 Key 格式
```
player:{username}
```

例如：
- 用户名: `player1` → KV key: `player:player1`
- 用户名: `张三` → KV key: `player:张三`

### 数据加载
- GameScene 的 `create()` 方法接收 `data.loadData` 参数
- 如果 `loadData` 存在，调用 `loadGameData()` 方法恢复所有系统数据

## ⚠️ 注意事项

1. **用户名唯一性**: 每个用户名对应一个独立的存档
2. **用户名格式**: 只允许字母、数字、中文和常见符号（`_`, `-`, `.`）
3. **用户名长度**: 1-20个字符
4. **数据隔离**: 不同用户名的数据完全独立，不会互相覆盖

## 🐛 问题修复

### 修复前
- 所有用户共享 `default_player` ID
- 云端保存时数据互相覆盖
- 保存功能经常失败

### 修复后
- 每个用户有独立的用户名和 playerId
- 数据完全隔离，不会互相覆盖
- 云端保存功能正常工作

## 📝 后续优化建议

1. **用户名验证**: 可以添加用户名重复检查（可选）
2. **用户列表**: 可以显示已保存的用户名列表
3. **删除存档**: 可以添加删除存档功能
4. **用户名修改**: 可以添加修改用户名功能（需要迁移数据）

---

**版本**: 1.1.0  
**更新日期**: 2024年12月22日  
**主要改进**: 添加用户名系统，修复云端保存问题

